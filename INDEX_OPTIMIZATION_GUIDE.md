# –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞ —Å CONCURRENTLY

–û—à–∏–±–∫–∞ `CREATE INDEX CONCURRENTLY cannot run inside a transaction block` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø–æ—Ç–æ–º—É, —á—Ç–æ:
- `CREATE INDEX CONCURRENTLY` —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç —Ä–µ–∂–∏–º–∞
- –ù–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`BEGIN...COMMIT`)
- –ù—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É –æ—Ç–¥–µ–ª—å–Ω–æ

## –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

### üü¢ **–í–∞—Ä–∏–∞–Ω—Ç 1: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –¥–ª—è PROD)**

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª `DATABASE_INDEX_OPTIMIZATION_FIXED.sql`

**–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ—ç—Ç–∞–ø–Ω–æ:**

#### –≠—Ç–∞–ø 1: –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å—å –±–ª–æ–∫ –∫–∞–∫ –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
BEGIN;
DROP INDEX IF EXISTS idx_claims_project;
DROP INDEX IF EXISTS idx_claims_status;
-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ DROP INDEX
COMMIT;
```

#### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤  
**–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É –û–¢–î–ï–õ–¨–ù–û:**
```sql
-- –ö–æ–º–∞–Ω–¥–∞ 1 (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)
CREATE INDEX CONCURRENTLY idx_court_cases_project_new ON court_cases(project_id);

-- –ö–æ–º–∞–Ω–¥–∞ 2 (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)  
CREATE INDEX CONCURRENTLY idx_court_cases_status_new ON court_cases(status);

-- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

### üü° **–í–∞—Ä–∏–∞–Ω—Ç 2: –ë—ã—Å—Ç—Ä—ã–π (–¥–ª—è DEV/STAGING)**

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª `DATABASE_INDEX_OPTIMIZATION_SIMPLE.sql`

**–û–¥–∏–Ω —Å–∫—Ä–∏–ø—Ç –±–µ–∑ CONCURRENTLY:**
- –ó–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ–ø–∏–∫–æ–≤—ã—Ö —á–∞—Å–æ–≤

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT 
    schemaname,
    tablename, 
    indexname,
    indexdef
FROM pg_indexes 
WHERE indexname LIKE '%_new' OR indexname LIKE '%created_by%'
ORDER BY tablename, indexname;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
EXPLAIN (ANALYZE, BUFFERS) 
SELECT COUNT(*) FROM court_cases 
WHERE project_id = 1 AND status = 2;
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```sql
SELECT 
    schemaname,
    tablename, 
    indexname,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes 
WHERE indexname LIKE '%_new' OR indexname LIKE '%created_by%'
ORDER BY idx_tup_read DESC;
```

## –û—Ç–∫–∞—Ç –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```sql
-- –£–¥–∞–ª–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã
DROP INDEX IF EXISTS idx_court_cases_project_new;
DROP INDEX IF EXISTS idx_court_cases_status_new;
-- ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–µ–∫—Å—ã  
CREATE INDEX idx_claims_project ON claims(project_id);
CREATE INDEX idx_claims_status ON claims(claim_status_id);
-- ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é

1. **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** –ù–µ–ø–∏–∫–æ–≤—ã–µ —á–∞—Å—ã (–Ω–æ—á—å/–≤—ã—Ö–æ–¥–Ω—ã–µ)
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ –¥–∏—Å–∫ –∏ CPU
3. **–ë—ç–∫–∞–ø:** –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –°–Ω–∞—á–∞–ª–∞ –Ω–∞ staging —Å—Ä–µ–¥–µ

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ –≤ 5-10 —Ä–∞–∑
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ –∑–∞—è–≤–æ–∫/–¥–µ—Ñ–µ–∫—Ç–æ–≤  
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö